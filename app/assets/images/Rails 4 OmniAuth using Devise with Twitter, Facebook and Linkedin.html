<!DOCTYPE html>
<!-- saved from url=(0084)http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/ -->
<html class=" js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths" lang="en" data-ember-extension="1"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <title>Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin</title> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="google-site-verification" content="lC7-hHwqtiRqo7YTHc1fJ6t8ie-Hs7J4o5u3XRIF9Vw"> <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="http://sourcey.com/feed.xml"> <link href="http://sourcey.com/stylesheets/app.css" media="screen" rel="stylesheet"> <script src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/cb=gapi.loaded_1" async=""></script><script src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/cb=gapi.loaded_0" async=""></script><script type="text/javascript" async="" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/ga.js"></script><script async="" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/analytics.js"></script><script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-836728-7', 'sourcey.com');
      ga('send', 'pageview');
    </script> <script type="text/javascript" async="" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/embed.js"></script><meta class="foundation-data-attribute-namespace"><meta class="foundation-mq-xxlarge"><meta class="foundation-mq-xlarge"><meta class="foundation-mq-large"><meta class="foundation-mq-medium"><meta class="foundation-mq-small"><style></style><meta class="foundation-mq-topbar"><script src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/nonSecureAnonymousFramework"></script><style type="text/css">* html #li_ui_li_gen_1402177864917_0 a#li_ui_li_gen_1402177864917_0-link{height:1% !important;}#li_ui_li_gen_1402177864917_0{position:relative !important;overflow:visible !important;display:block !important;}#li_ui_li_gen_1402177864917_0 a#li_ui_li_gen_1402177864917_0-link{border:0 !important;height:20px !important;text-decoration:none !important;padding:0 !important;margin:0 !important;display:inline-block !important;}#li_ui_li_gen_1402177864917_0 a#li_ui_li_gen_1402177864917_0-link:link, #li_ui_li_gen_1402177864917_0 a#li_ui_li_gen_1402177864917_0-link:visited, #li_ui_li_gen_1402177864917_0 a#li_ui_li_gen_1402177864917_0-link:hover, #li_ui_li_gen_1402177864917_0 a#li_ui_li_gen_1402177864917_0-link:active{border:0 !important;text-decoration:none !important;}#li_ui_li_gen_1402177864917_0 a#li_ui_li_gen_1402177864917_0-link:after{content:"." !important;display:block !important;clear:both !important;visibility:hidden !important;line-height:0 !important;height:0 !important;}#li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-logo{background-image:url(http://s.c.lnkd.licdn.com/scds/common/u/images/apps/connect/sprites/sprite_connect_v14.png) !important;background-position:0px -276px !important;background-repeat:no-repeat !important;background-size:initial !important;cursor:pointer !important;border:0 !important;text-indent:-9999em !important;overflow:hidden !important;padding:0 !important;margin:0 !important;position:absolute !important;left:0px !important;top:0px !important;display:block !important;width:20px !important;height:20px !important;float:right !important;border-radius:0 !important;-webkit-border-radius:0 !important;border-top-right-radius:2px !important;border-bottom-right-radius:2px !important;-webkit-border-top-right-radius:2px !important;-webkit-border-bottom-right-radius:2px !important;}#li_ui_li_gen_1402177864917_0.hovered #li_ui_li_gen_1402177864917_0-logo{background-position:-20px -276px !important;}#li_ui_li_gen_1402177864917_0.clicked #li_ui_li_gen_1402177864917_0-logo, #li_ui_li_gen_1402177864917_0.down #li_ui_li_gen_1402177864917_0-logo{background-position:-40px -276px !important;}.IN-shadowed #li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-logo{}#li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title{color:#333 !important;cursor:pointer !important;display:block !important;white-space:nowrap !important;float:left !important;margin-left:1px !important;vertical-align:top !important;overflow:hidden !important;text-align:center !important;height:18px !important;padding:0 4px 0 23px !important;border:1px solid #000 !important;border-top-color:#E2E2E2 !important;border-right-color:#BFBFBF !important;border-bottom-color:#B9B9B9 !important;border-left-color:#E2E2E2 !important;border-left:0 !important;text-shadow:#FFFFFF -1px 1px 0 !important;line-height:20px !important;border-radius:0 !important;-webkit-border-radius:0 !important;border-top-right-radius:2px !important;border-bottom-right-radius:2px !important;-webkit-border-top-right-radius:2px !important;-webkit-border-bottom-right-radius:2px !important;background-color:#ECECEC !important;background-image:-webkit-gradient(linear, left top, left bottom, color-stop(0%,#FEFEFE), color-stop(100%,#ECECEC)) !important; background-image: -webkit-linear-gradient(top, #FEFEFE 0%, #ECECEC 100%) !important;}#li_ui_li_gen_1402177864917_0.hovered #li_ui_li_gen_1402177864917_0-title{border:1px solid #000 !important;border-top-color:#ABABAB !important;border-right-color:#9A9A9A !important;border-bottom-color:#787878 !important;border-left-color:#04568B !important;border-left:0 !important;background-color:#EDEDED !important;background-image:-webkit-gradient(linear, left top, left bottom, color-stop(0%,#EDEDED), color-stop(100%,#DEDEDE)) !important; background-image: -webkit-linear-gradient(top, #EDEDED 0%, #DEDEDE 100%) !important;}#li_ui_li_gen_1402177864917_0.clicked #li_ui_li_gen_1402177864917_0-title, #li_ui_li_gen_1402177864917_0.down #li_ui_li_gen_1402177864917_0-title{color:#666 !important;border:1px solid #000 !important;border-top-color:#B6B6B6 !important;border-right-color:#B3B3B3 !important;border-bottom-color:#9D9D9D !important;border-left-color:#49627B !important;border-left:0 !important;background-color:#DEDEDE !important;background-image:-webkit-gradient(linear, left top, left bottom, color-stop(0%,#E3E3E3), color-stop(100%,#EDEDED)) !important; background-image: -webkit-linear-gradient(top, #E3E3E3 0%, #EDEDED 100%) !important;}.IN-shadowed #li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title{}.IN-shadowed #li_ui_li_gen_1402177864917_0.hovered #li_ui_li_gen_1402177864917_0-title{}.IN-shadowed #li_ui_li_gen_1402177864917_0.clicked #li_ui_li_gen_1402177864917_0-title, .IN-shadowed #li_ui_li_gen_1402177864917_0.down #li_ui_li_gen_1402177864917_0-title{}#li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title-text, #li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title-text *{color:#333 !important;font-size:11px !important;font-family:Arial, sans-serif !important;font-weight:bold !important;font-style:normal !important;-webkit-font-smoothing:antialiased !important;display:inline-block !important;background:transparent none !important;vertical-align:top !important;height:18px !important;line-height:20px !important;float:none !important;}#li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title-text strong{font-weight:bold !important;}#li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title-text em{font-style:italic !important;}#li_ui_li_gen_1402177864917_0.hovered #li_ui_li_gen_1402177864917_0-title-text, #li_ui_li_gen_1402177864917_0.hovered #li_ui_li_gen_1402177864917_0-title-text *{color:#000 !important;}#li_ui_li_gen_1402177864917_0.clicked #li_ui_li_gen_1402177864917_0-title-text, #li_ui_li_gen_1402177864917_0.down #li_ui_li_gen_1402177864917_0-title-text, #li_ui_li_gen_1402177864917_0.clicked #li_ui_li_gen_1402177864917_0-title-text *, #li_ui_li_gen_1402177864917_0.down #li_ui_li_gen_1402177864917_0-title-text *{color:#666 !important;}#li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title #li_ui_li_gen_1402177864917_0-mark{display:inline-block !important;width:0px !important;overflow:hidden !important;}.success #li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title{color:#333 !important;border-top-color:#E2E2E2 !important;border-right-color:#BFBFBF !important;border-bottom-color:#B9B9B9 !important;border-left-color:#E2E2E2 !important;background-color:#ECECEC !important;background-image:-webkit-gradient(linear, left top, left bottom, color-stop(0%,#FEFEFE), color-stop(100%,#ECECEC)) !important; background-image: -webkit-linear-gradient(top, #FEFEFE 0%, #ECECEC 100%) !important;}.success #li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title-text, .success #li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title-text *{color:#333 !important;}.IN-shadowed .success #li_ui_li_gen_1402177864917_0 #li_ui_li_gen_1402177864917_0-title{}.success #li_ui_li_gen_1402177864917_0.hovered #li_ui_li_gen_1402177864917_0-title{color:#000 !important;border-top-color:#ABABAB !important;border-right-color:#9A9A9A !important;border-bottom-color:#787878 !important;border-left-color:#04568B !important;background-color:#EDEDED !important;background-image:-webkit-gradient(linear, left top, left bottom, color-stop(0%,#EDEDED), color-stop(100%,#DEDEDE)) !important; background-image: -webkit-linear-gradient(top, #EDEDED 0%, #DEDEDE 100%) !important;}.success #li_ui_li_gen_1402177864917_0.hovered #li_ui_li_gen_1402177864917_0-title-text, .success #li_ui_li_gen_1402177864917_0.hovered #li_ui_li_gen_1402177864917_0-title-text *{color:#000 !important;}.success #li_ui_li_gen_1402177864917_0.clicked #li_ui_li_gen_1402177864917_0-title, .success #li_ui_li_gen_1402177864917_0.down #li_ui_li_gen_1402177864917_0-title{color:#666 !important;border-top-color:#B6B6B6 !important;border-right-color:#B3B3B3 !important;border-bottom-color:#9D9D9D !important;border-left-color:#49627B !important;background-color:#DEDEDE !important;background-image:-webkit-gradient(linear, left top, left bottom, color-stop(0%,#E3E3E3), color-stop(100%,#EDEDED)) !important; background-image: -webkit-linear-gradient(top, #E3E3E3 0%, #EDEDED 100%) !important;}.success #li_ui_li_gen_1402177864917_0.clicked #li_ui_li_gen_1402177864917_0-title-text, .success #li_ui_li_gen_1402177864917_0.down #li_ui_li_gen_1402177864917_0-title-text, .success #li_ui_li_gen_1402177864917_0.clicked #li_ui_li_gen_1402177864917_0-title-text *, .success #li_ui_li_gen_1402177864917_0.down #li_ui_li_gen_1402177864917_0-title-text *{color:#666 !important;}.IN-shadowed .success #li_ui_li_gen_1402177864917_0.clicked #li_ui_li_gen_1402177864917_0-title, .IN-shadowed .success #li_ui_li_gen_1402177864917_0.down #li_ui_li_gen_1402177864917_0-title{}#li_ui_li_gen_1402177864926_1-container.IN-top {display:inline-block !important;overflow:visible !important;position:relative !important;height:42px !important;line-height:1px !important;cursor:pointer !important;}#li_ui_li_gen_1402177864926_1.IN-top {display:inline-block !important;height:42px !important;width:57px !important;text-align:center !important;background-image:url(http://s.c.lnkd.licdn.com/scds/common/u/images/apps/connect/sprites/sprite_connect_v14.png) !important;background-color:transparent !important;background-repeat:no-repeat !important;background-position:-150px top !important;}#li_ui_li_gen_1402177864926_1-content.IN-top {display:inline !important;font-size:16px !important;color:#04558B !important;font-weight:bold !important;font-family:Arial, sans-serif !important;line-height:38px !important;}#li_ui_li_gen_1402177864926_1-container.IN-empty #li_ui_li_gen_1402177864926_1-inner.IN-top {background-image:url(http://s.c.lnkd.licdn.com/scds/common/u/images/apps/connect/sprites/sprite_connect_v14.png) !important;background-color:transparent !important;background-repeat:no-repeat !important;background-position:0px -20px !important;overflow:hidden !important;margin:5px auto 0 auto !important;width:26px !important;height:26px !important;display:block !important;}#li_ui_li_gen_1402177864926_1-container.IN-empty #li_ui_li_gen_1402177864926_1-content.IN-top {text-indent:-999px !important;display:inline-block !important;}#li_ui_li_gen_1402177864926_1-container.IN-hidden #li_ui_li_gen_1402177864926_1 {display:none !important;}</style><style type="text/css">.fb_hidden{position:absolute;top:-10000px;z-index:10001}.fb_invisible{display:none}.fb_reset{background:none;border:0;border-spacing:0;color:#000;cursor:auto;direction:ltr;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}.fb_reset>div{overflow:hidden}.fb_link img{border:none}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}.fb_reset .fb_dialog_legacy{overflow:visible}.fb_dialog_advanced{padding:10px;-moz-border-radius:8px;-webkit-border-radius:8px;border-radius:8px}.fb_dialog_content{background:#fff;color:#333}.fb_dialog_close_icon{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif);cursor:pointer;display:block;height:15px;position:absolute;right:18px;top:17px;width:15px}.fb_dialog_mobile .fb_dialog_close_icon{top:5px;left:5px;right:auto}.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}.fb_dialog_close_icon:hover{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}.fb_dialog_close_icon:active{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}.fb_dialog_loader{background-color:#f2f2f2;border:1px solid #606060;font-size:24px;padding:20px}.fb_dialog_top_left,.fb_dialog_top_right,.fb_dialog_bottom_left,.fb_dialog_bottom_right{height:10px;width:10px;overflow:hidden;position:absolute}.fb_dialog_top_left{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 0;left:-10px;top:-10px}.fb_dialog_top_right{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -10px;right:-10px;top:-10px}.fb_dialog_bottom_left{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -20px;bottom:-10px;left:-10px}.fb_dialog_bottom_right{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -30px;right:-10px;bottom:-10px}.fb_dialog_vert_left,.fb_dialog_vert_right,.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{position:absolute;background:#525252;filter:alpha(opacity=70);opacity:.7}.fb_dialog_vert_left,.fb_dialog_vert_right{width:10px;height:100%}.fb_dialog_vert_left{margin-left:-10px}.fb_dialog_vert_right{right:0;margin-right:-10px}.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{width:100%;height:10px}.fb_dialog_horiz_top{margin-top:-10px}.fb_dialog_horiz_bottom{bottom:0;margin-bottom:-10px}.fb_dialog_iframe{line-height:0}.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #3b5998;color:#fff;font-size:14px;font-weight:bold;margin:0}.fb_dialog_content .dialog_title>span{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yd/r/Cou7n-nqK52.gif) no-repeat 5px 50%;float:left;padding:5px 0 7px 26px}body.fb_hidden{-webkit-transform:none;height:100%;margin:0;overflow:visible;position:absolute;top:-10000px;left:0;width:100%}.fb_dialog.fb_dialog_mobile.loading{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ya/r/3rhSv5V8j3o.gif) white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}.fb_dialog.fb_dialog_mobile.loading.centered{max-height:590px;min-height:590px;max-width:500px;min-width:500px}#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .45);position:absolute;left:0;top:0;width:100%;min-height:100%;z-index:10000}#fb-root #fb_dialog_ipad_overlay.hidden{display:none}.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}.fb_dialog_content .dialog_header{-webkit-box-shadow:white 0 1px 1px -1px inset;background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#738ABA), to(#2C4987));border-bottom:1px solid;border-color:#1d4088;color:#fff;font:14px Helvetica, sans-serif;font-weight:bold;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}.fb_dialog_content .dialog_header table{-webkit-font-smoothing:subpixel-antialiased;height:43px;width:100%}.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-left:5px;vertical-align:middle;width:60px}.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-right:5px;vertical-align:middle;width:60px}.fb_dialog_content .touchable_button{background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#4966A6), color-stop(.5, #355492), to(#2A4887));border:1px solid #29447e;-webkit-background-clip:padding-box;-webkit-border-radius:3px;-webkit-box-shadow:rgba(0, 0, 0, .117188) 0 1px 1px inset, rgba(255, 255, 255, .167969) 0 1px 0;display:inline-block;margin-top:3px;max-width:85px;line-height:18px;padding:4px 12px;position:relative}.fb_dialog_content .dialog_header .touchable_button input{border:none;background:none;color:#fff;font:12px Helvetica, sans-serif;font-weight:bold;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}.fb_dialog_content .dialog_content{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #555;border-bottom:0;border-top:0;height:150px}.fb_dialog_content .dialog_footer{background:#f2f2f2;border:1px solid #555;border-top-color:#ccc;height:40px}#fb_dialog_loader_close{float:left}.fb_dialog.fb_dialog_mobile .fb_dialog_close_button{text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}
.fb_iframe_widget{display:inline-block;position:relative}.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify}.fb_iframe_widget iframe{position:absolute}.fb_iframe_widget_lift{z-index:1}.fb_hide_iframes iframe{position:relative;left:-10000px}.fb_iframe_widget_loader{position:relative;display:inline-block}.fb_iframe_widget_fluid{display:inline}.fb_iframe_widget_fluid span{width:100%}.fb_iframe_widget_loader iframe{min-height:32px;z-index:2;zoom:1}.fb_iframe_widget_loader .FB_Loader{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat;height:32px;width:32px;margin-left:-16px;position:absolute;left:50%;z-index:4}
.fb_connect_bar_container div,.fb_connect_bar_container span,.fb_connect_bar_container a,.fb_connect_bar_container img,.fb_connect_bar_container strong{background:none;border-spacing:0;border:0;direction:ltr;font-style:normal;font-variant:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal;vertical-align:baseline}.fb_connect_bar_container{position:fixed;left:0 !important;right:0 !important;height:42px !important;padding:0 25px !important;margin:0 !important;vertical-align:middle !important;border-bottom:1px solid #333 !important;background:#3b5998 !important;z-index:99999999 !important;overflow:hidden !important}.fb_connect_bar_container_ie6{position:absolute;top:expression(document.compatMode=="CSS1Compat"? document.documentElement.scrollTop+"px":body.scrollTop+"px")}.fb_connect_bar{position:relative;margin:auto;height:100%;width:100%;padding:6px 0 0 0 !important;background:none;color:#fff !important;font-family:"lucida grande", tahoma, verdana, arial, sans-serif !important;font-size:13px !important;font-style:normal !important;font-variant:normal !important;font-weight:normal !important;letter-spacing:normal !important;line-height:1 !important;text-decoration:none !important;text-indent:0 !important;text-shadow:none !important;text-transform:none !important;white-space:normal !important;word-spacing:normal !important}.fb_connect_bar a:hover{color:#fff}.fb_connect_bar .fb_profile img{height:30px;width:30px;vertical-align:middle;margin:0 6px 5px 0}.fb_connect_bar div a,.fb_connect_bar span,.fb_connect_bar span a{color:#bac6da;font-size:11px;text-decoration:none}.fb_connect_bar .fb_buttons{float:right;margin-top:7px}
.fbpluginrecommendationsbarleft,.fbpluginrecommendationsbarright{position:fixed !important;bottom:0;z-index:999}.fbpluginrecommendationsbarleft{left:10px}.fbpluginrecommendationsbarright{right:10px}</style></head> <body class="article rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin_index" data-ember-extension="1" data-twttr-rendered="true"> <nav class="top-bar" data-topbar=""> <div class="top-bar-inner"> <div id="social"> <a href="https://plus.google.com/+SourceyDevel"><i class="fi-social-google-plus large"></i></a> <a href="https://facebook.com/sourceydevel"><i class="fi-social-facebook large"></i></a> <a href="https://twitter.com/sourceydevel"><i class="fi-social-twitter large"></i></a> <a href="https://github.com/sourcey"><i class="fi-social-github large"></i></a> </div> <ul class="title-area"> <li class="name"></li> <li class="toggle-topbar menu-icon"><a href="" class="left"></a></li> </ul>  </div> <section class="top-bar-section" style="left: 0%;"> <ul class="left"> <li class="has-dropdown not-click"><a href="http://sourcey.com/#projects">Projects</a> <ul class="dropdown"><li class="title back js-generated"><h5><a href="javascript:void(0)">Back</a></h5></li> <li> <a href="http://sourcey.com/libsourcey"><b>LibSourcey</b><small>C++ networking evolved</small></a> </li> <li> <a href="http://sourcey.com/anionu"><b>Anionu</b><small>Cloud video surveillance</small></a> </li> <li> <a href="http://stompstart.com/"><b>StompStart</b><small>Promote your startup</small></a> </li> <li> <a href="http://sourcey.com/symple"><b>Symple</b><small>Messaging made Symple</small></a> </li> <li> <a href="http://sourcey.com/mesh"><b>Mesh</b><small>Elegant, modern design</small></a> </li> <li> <a href="http://sourcey.com/pacm"><b>Pacm</b><small>Redistributable package manager</small></a> </li> <li> <a href="http://sourcey.com/pluga"><b>Pluga</b><small>C++ plugin system</small></a> </li> </ul> </li> <li class="has-dropdown not-click"><a href="http://sourcey.com/#articles">Articles</a> <ul class="dropdown"><li class="title back js-generated"><h5><a href="javascript:void(0)">Back</a></h5></li> <li><a href="http://sourcey.com/archives">Archives</a></li> <li><a href="http://sourcey.com/feed.xml">Feed</a></li> </ul> </li> <li><a href="mailto:hello@sourcey.com">Contact</a></li> <li class="divider"></li> </ul> </section></nav> <header id="header"> <h1 id="logo"> <a title="Sourcey" rel="home" href="http://sourcey.com/"><img height="150" width="150" title="Sourcey" alt="Sourcey" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/sourcey-glow-250x250.png"></a> </h1> </header> <div id="main" role="main"> <article> <header class="article-header"> <h1>Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin</h1> <div class="meta"> By <a rel="author external" href="https://plus.google.com/+KamLow">Kam Low</a> ♦ <time class="updated" datetime="Mar 26 2014">Mar 26 2014</time> </div> </header> <div class="article-wrap row"> <div class="large-9 columns"> <div class="content">   <p><img alt="OmniAuth" title="OmniAuth" class="align-left" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/omniauth-158x182.png"> There are quite a few OAuth solutions out there, but I want to share the one we use since it allows you to intelligently link multiple OAuth identities with a single user entity. If you use 90% of the code examples on the Internet you will wind up with a new user entity each time the user signs in with a different OAuth provider, and a bunch of very confused users.</p> <p>The OAuth provider that throws a spanner in the works and adds convolution to our code is Twitter. Unlike other providers, Twitter doesn’t share their user’s email address, so we need to add an extra step to get it from the user. More info on that <a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#completing-the-signup-process">here</a>. </p> <p>Thanks to everyone who submitted comments and changes! For a list of code changes <a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#changes">see here</a>.</p> <h2 id="/basic-implementation">Basic Implementation</h2> <p>So, without further ado, here is the code:</p> <h4 id="/gemfile">Gemfile</h4> <pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'devise'</span>
<span class="n">gem</span> <span class="s1">'omniauth'</span>
<span class="n">gem</span> <span class="s1">'omniauth-twitter'</span>
<span class="n">gem</span> <span class="s1">'omniauth-facebook'</span>
<span class="n">gem</span> <span class="s1">'omniauth-linkedin'</span>
</code></pre> <h4 id="/generate-migrations-and-models">Generate migrations and models</h4> <pre><code class="highlight ruby"><span class="n">rails</span> <span class="n">generate</span> <span class="n">devise</span><span class="ss">:install</span>
<span class="n">rails</span> <span class="n">generate</span> <span class="n">devise</span> <span class="n">user</span>
<span class="n">rails</span> <span class="n">g</span> <span class="n">migration</span> <span class="n">add_name_to_users</span> <span class="nb">name</span><span class="ss">:string</span>
<span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">identity</span> <span class="n">user</span><span class="ss">:references</span> <span class="n">provider</span><span class="ss">:string</span> <span class="n">uid</span><span class="ss">:string</span>

<span class="c1"># Modify the db/migrate/[timestamp]_add_devise_to_users.rb to configure the Devise modules you will use.</span>
<span class="c1"># We usually enable the "confirmable" module when enabling email signups.</span>
</code></pre> <h4 id="/appmodelsidentityrb">app/models/identity.rb</h4> <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Identity</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates_presence_of</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:provider</span>
  <span class="n">validates_uniqueness_of</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:scope</span> <span class="o">=&gt;</span> <span class="ss">:provider</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_oauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">find_by</span><span class="p">(</span><span class="ss">provider: </span><span class="n">auth</span><span class="p">.</span><span class="nf">provider</span><span class="p">,</span> <span class="ss">uid: </span><span class="n">auth</span><span class="p">.</span><span class="nf">uid</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">uid: </span><span class="n">auth</span><span class="p">.</span><span class="nf">uid</span><span class="p">,</span> <span class="ss">provider: </span><span class="n">auth</span><span class="p">.</span><span class="nf">provider</span><span class="p">)</span> <span class="k">if</span> <span class="n">identity</span><span class="p">.</span><span class="nf">nil?</span>
    <span class="n">identity</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <h4 id="/appconfiginitializersdeviserb">app/config/initializers/devise.rb</h4> <pre><code class="highlight ruby"><span class="no">Devise</span><span class="p">.</span><span class="nf">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">omniauth</span> <span class="ss">:facebook</span><span class="p">,</span> <span class="s2">"KEY"</span><span class="p">,</span> <span class="s2">"SECRET"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">omniauth</span> <span class="ss">:twitter</span><span class="p">,</span> <span class="s2">"KEY"</span><span class="p">,</span> <span class="s2">"SECRET"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">omniauth</span> <span class="ss">:linked_in</span><span class="p">,</span> <span class="s2">"KEY"</span><span class="p">,</span> <span class="s2">"SECRET"</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
<span class="k">end</span>
</code></pre> <h4 id="/configenvironmentsenvironmentrb">config/environments/[environment].rb</h4> <pre><code class="highlight ruby"><span class="p">.</span><span class="nf">.</span><span class="o">.</span>
  <span class="c1"># Email</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">perform_deliveries</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">config</span><span class="p">.</span><span class="nf">app_domain</span> <span class="p">}</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">address: </span><span class="s1">'smtp.gmail.com'</span><span class="p">,</span> 
    <span class="ss">port: </span><span class="s1">'587'</span><span class="p">,</span>
    <span class="ss">enable_starttls_auto: </span><span class="kp">true</span><span class="p">,</span>
    <span class="ss">user_name: </span><span class="s1">'someuser'</span><span class="p">,</span>
    <span class="ss">password: </span><span class="s1">'somepass'</span><span class="p">,</span>
    <span class="n">authentication</span> <span class="o">=&gt;</span> <span class="ss">:plain</span><span class="p">,</span>
    <span class="n">domain</span> <span class="o">=&gt;</span> <span class="s1">'somedomain.com'</span>
  <span class="p">}</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
</code></pre> <h4 id="/configroutesrb">config/routes.rb</h4> <pre><code class="highlight ruby"><span class="p">.</span><span class="nf">.</span><span class="o">.</span>
  <span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:controllers</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">omniauth_callbacks: </span><span class="s1">'omniauth_callbacks'</span> <span class="p">}</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
</code></pre> <h4 id="/appcontrollersomniauthcallbackscontrollerrb">app/controllers/omniauth_callbacks_controller.rb</h4> <p>It’s worth mentioning that the only safe criteria for matching user entities with OAuth providers is a verified email address, but this will lead to the creation of multiple accounts if the user has different email addresses associated with different OAuth providers. Let’s say, for example, the user registers with Facebook, and then later tries to signin with a LinkedIn account that has a different email address associated, the system can only create a new account because there’s no way to match the existing user entity with the LinkedIn account.</p> <p>Therefore, to link accounts with multiple providers the <code>current_user</code> session must be already set when the OAuth callback returns, and passed to <code>User.find_for_oauth</code>. This might sound complicated, but all thats required to link a different provider, Facebook for example, is to <code>redirect_to user_omniauth_authorize_path(:facebook)</code> while the user is already logged in.</p> <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">OmniauthCallbacksController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">provides_callback_for</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
    <span class="nb">class_eval</span> <span class="sx">%Q{
      def </span><span class="si">#{</span><span class="n">provider</span><span class="si">}</span><span class="sx">
        @user = User.find_for_oauth(env["omniauth.auth"], current_user)

        if @user.persisted?
          sign_in_and_redirect @user, event: :authentication
          set_flash_message(:notice, :success, kind: "</span><span class="si">#{</span><span class="n">provider</span><span class="si">}</span><span class="sx">".capitalize) if is_navigational_format?
        else
          session["devise.</span><span class="si">#{</span><span class="n">provider</span><span class="si">}</span><span class="sx">_data"] = env["omniauth.auth"]
          redirect_to new_user_registration_url
        end
      end
    }</span>
  <span class="k">end</span>

  <span class="o">[</span><span class="ss">:twitter</span><span class="p">,</span> <span class="ss">:facebook</span><span class="p">,</span> <span class="ss">:linked_in</span><span class="o">]</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
    <span class="n">provides_callback_for</span> <span class="n">provider</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">after_sign_in_path_for</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resource</span><span class="p">.</span><span class="nf">email_verified?</span>
      <span class="k">super</span> <span class="n">resource</span>
    <span class="k">else</span>
      <span class="n">finish_signup_path</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <h4 id="/appmodelsuserrb">app/models/user.rb</h4> <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="no">TEMP_EMAIL_PREFIX</span> <span class="o">=</span> <span class="s1">'change@me'</span>
  <span class="no">TEMP_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\Achange@me/</span>

  <span class="c1"># Include default devise modules. Others available are:</span>
  <span class="c1"># :lockable, :timeoutable</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span> <span class="ss">:confirmable</span><span class="p">,</span>
    <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span><span class="p">,</span> <span class="ss">:omniauthable</span>

  <span class="n">validates_format_of</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:without</span> <span class="o">=&gt;</span> <span class="no">TEMP_EMAIL_REGEX</span><span class="p">,</span> <span class="ss">on: :update</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_oauth</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">signed_in_resource</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>

    <span class="c1"># Get the identity and user if they exist</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="no">Identity</span><span class="p">.</span><span class="nf">find_for_oauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>

    <span class="c1"># If a signed_in_resource is provided it always overrides the existing user</span>
    <span class="c1"># to prevent the identity being locked with accidentally created accounts.</span>
    <span class="c1"># Note that this may leave zombie accounts (with no associated identity) which</span>
    <span class="c1"># can be cleaned up at a later date.</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">signed_in_resource</span> <span class="p">?</span> <span class="n">signed_in_resource</span> <span class="p">:</span> <span class="n">identity</span><span class="p">.</span><span class="nf">user</span>

    <span class="c1"># Create the user if needed</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">nil?</span>

      <span class="c1"># Get the existing user by email if the provider gives us a verified email.</span>
      <span class="c1"># If no verified email was provided we assign a temporary email and ask the</span>
      <span class="c1"># user to verify it on the next step via UsersController.finish_signup</span>
      <span class="n">email_is_verified</span> <span class="o">=</span> <span class="n">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">email</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">verified</span> <span class="o">||</span> <span class="n">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">verified_email</span><span class="p">)</span>
      <span class="n">email</span> <span class="o">=</span> <span class="n">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">email</span> <span class="k">if</span> <span class="n">email_is_verified</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">).</span><span class="nf">first</span> <span class="k">if</span> <span class="n">email</span>

      <span class="c1"># Create the user if it's a new registration</span>
      <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
          <span class="nb">name</span><span class="p">:</span> <span class="n">auth</span><span class="p">.</span><span class="nf">extra</span><span class="p">.</span><span class="nf">raw_info</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
          <span class="c1">#username: auth.info.nickname || auth.uid,</span>
          <span class="ss">email: </span><span class="n">email</span> <span class="p">?</span> <span class="n">email</span> <span class="p">:</span> <span class="s2">"</span><span class="si">#{</span><span class="no">TEMP_EMAIL_PREFIX</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">auth</span><span class="p">.</span><span class="nf">uid</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">auth</span><span class="p">.</span><span class="nf">provider</span><span class="si">}</span><span class="s2">.com"</span><span class="p">,</span>
          <span class="ss">password: </span><span class="no">Devise</span><span class="p">.</span><span class="nf">friendly_token</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="o">]</span>
        <span class="p">)</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">skip_confirmation!</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">save!</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># Associate the identity with the user if needed</span>
    <span class="k">if</span> <span class="n">identity</span><span class="p">.</span><span class="nf">user</span> <span class="o">!=</span> <span class="n">user</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">save!</span>
    <span class="k">end</span>
    <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">email_verified?</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">email</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">email</span> <span class="o">!~</span> <span class="no">TEMP_EMAIL_REGEX</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <h2 id="/completing-the-signup-process">Completing the Signup Process</h2> <p>Most OAuth providers give us all the information we need, but if the user signed up with Twitter, or perhaps for some reason the OAuth provider didn’t provide a verified email address, or maybe you just want to get some extra information from the user, then we need to implement an extra step for this.</p> <h4 id="/configroutesrb-1">config/routes.rb</h4> <pre><code class="highlight ruby"><span class="p">.</span><span class="nf">.</span><span class="o">.</span>
  <span class="n">match</span> <span class="s1">'/profile/:id/finish_signup'</span> <span class="o">=&gt;</span> <span class="s1">'users#finish_signup'</span><span class="p">,</span> <span class="ss">via: </span><span class="o">[</span><span class="ss">:get</span><span class="p">,</span> <span class="ss">:patch</span><span class="o">]</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:finish_signup</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
</code></pre> <h4 id="/appcontrollersuserscontrollerrb">app/controllers/users_controller.rb</h4> <p>If you’re using the Devise confirmable module to verify email signups, then you may want to skip email confirmation here in order to avoid killing all the OAuth joy for the user. However, if you do want to force the user to confirm their email address then just comment out the <code>current_user.skip_reconfirmation!</code> line below. The real question is; do you trust Twitter users to provide you with a valid email address?</p> <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">:finish_signup</span>

  <span class="p">.</span><span class="nf">.</span><span class="o">.</span>

  <span class="k">def</span> <span class="nf">finish_signup</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">patch?</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span> <span class="c1">#&amp;&amp; params[:user][:email]</span>
      <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
        <span class="n">current_user</span><span class="p">.</span><span class="nf">skip_reconfirmation!</span>
        <span class="n">sign_in</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="ss">:bypass</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
        <span class="n">redirect_to</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">notice: </span><span class="s1">'Your profile was successfully updated.'</span>
      <span class="k">else</span>
        <span class="vi">@show_errors</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">set_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">accessible</span> <span class="o">=</span> <span class="o">[</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">]</span> <span class="c1"># extend with your own params</span>
      <span class="n">accessible</span> <span class="o">&lt;&lt;</span> <span class="o">[</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">]</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">.</span><span class="nf">blank?</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="n">accessible</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre> <h4 id="/appviewsusersfinishsignuphtmlerb">app/views/users/finish_signup.html.erb</h4> <p>In our implementation, the form below only collects an email address from the user, but you could easily add other required fields, and even request the user specify a password at this point so they can login with an email and password later on. Note that the following template uses Bootstrap markup. </p> <pre><code class="highlight html"><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"add-email"</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Add Email<span class="nt">&lt;/h1&gt;</span>
  <span class="err">&lt;</span>%= form_for(current_user, :as =&gt; 'user', :url =&gt; finish_signup_path(current_user), :html =&gt; { role: 'form'}) do |f| %&gt;
    <span class="err">&lt;</span>% if @show_errors <span class="err">&amp;&amp;</span> current_user.errors.any? %&gt;
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
        <span class="err">&lt;</span>% current_user.errors.full_messages.each do |msg| %&gt;
          <span class="err">&lt;</span>%= msg %&gt;<span class="nt">&lt;br&gt;</span>
        <span class="err">&lt;</span>% end %&gt;
      <span class="nt">&lt;/div&gt;</span>
    <span class="err">&lt;</span>% end %&gt;
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="err">&lt;</span>%= f.label :email %&gt;
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
        <span class="err">&lt;</span>%= f.text_field :email, :autofocus =&gt; true, :value =&gt; '', class: 'form-control input-lg', placeholder: 'Example: email@me.com' %&gt;
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"help-block"</span><span class="nt">&gt;</span>Please confirm your email address. No spam.<span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
      <span class="err">&lt;</span>%= f.submit 'Continue', :class =&gt; 'btn btn-primary' %&gt;
    <span class="nt">&lt;/div&gt;</span>
  <span class="err">&lt;</span>% end %&gt;
<span class="nt">&lt;/div&gt;</span>
</code></pre> <h4 id="/appcontrollersapplicationcontrollerrb">app/controllers/application_controller.rb</h4> <p>The following method is optional, but it’s useful if you want to ensure the user has provided all the necessary information before accessing a specific resource.</p> <p>You can use it in a <code>before_filter</code> like so: <code>before_filter :ensure_signup_complete, only: [:new, :create, :update, :destroy]</code></p> <pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>

  <span class="p">.</span><span class="nf">.</span><span class="o">.</span>

  <span class="k">def</span> <span class="nf">ensure_signup_complete</span>
    <span class="c1"># Ensure we don't go into an infinite loop</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">'finish_signup'</span>

    <span class="c1"># Redirect to the 'finish_signup' page if the user</span>
    <span class="c1"># email hasn't been verified yet</span>
    <span class="k">if</span> <span class="n">current_user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user</span><span class="p">.</span><span class="nf">email_verified?</span>
      <span class="n">redirect_to</span> <span class="n">finish_signup_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <p>Well that’s pretty much it! If I left anything out please give me a shout and I’ll update the article, cheers!</p> <h2 id="/changes">Changes</h2> <ul> <li>Add <code>UsersController.set_user</code> method for clarity</li> <li>Remove duplicate controller methods from <code>OmniauthCallbacksController</code> </li> <li>Only accept verified email addresses from the provider via ‘User.find_for_oauth’</li> <li>Remove redundant <code>gem "omniauth"</code> from <code>Gemfile</code> </li> <li>Update <code>User.find_for_oauth</code> to better handle <code>signed_in_resource</code>. Thanks <a href="https://github.com/mtuckerb">@mtuckerb</a> </li> <li>Rename <code>UsersController.add_email</code> to <code>UsersController.finish_signup</code> </li> <li>Rename <code>ApplicationController.ensure_valid_email</code> to <code>ApplicationController.ensure_signup_complete</code> </li> <li>Override <code>OmniauthCallbacksController.after_sign_in_path_for</code> to redirect to <code>UsersController.finish_signup</code> instead of forcing via <code>before_filter</code> </li> <li>Add <code>UsersController.user_params</code> to filter <code>:password</code> and <code>:password_confirmation</code> when blank</li> <li>Temporary email addresses are now unique</li> <li> <code>signed_in_resource</code> always overrides existing user entity in <code>User.find_for_oauth</code> </li> </ul>  </div> </div> <div class="large-3 columns"> <div class="sidebar float"> <div class="sidebar-section toc"> <h4 class="no_toc" id="/contents">Contents<a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#top">⇑</a></h4> <ul id="markdown-toc"> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#" class="toggle"><span class="open">⇓</span><span class="close">⇐</span></a> <a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/basic-implementation">Basic Implementation</a> <ul> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/gemfile">Gemfile</a></li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/generate-migrations-and-models">Generate migrations and models</a></li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/appmodelsidentityrb">app/models/identity.rb</a></li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/appconfiginitializersdeviserb">app/config/initializers/devise.rb</a></li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/configenvironmentsenvironmentrb">config/environments/[environment].rb</a></li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/configroutesrb">config/routes.rb</a></li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/appcontrollersomniauthcallbackscontrollerrb">app/controllers/omniauth_callbacks_controller.rb</a></li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/appmodelsuserrb">app/models/user.rb</a></li> </ul> </li> <li class="closed"><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#" class="toggle"><span class="open">⇓</span><span class="close">⇐</span></a> <a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/completing-the-signup-process">Completing the Signup Process</a> <ul> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/configroutesrb-1">config/routes.rb</a></li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/appcontrollersuserscontrollerrb">app/controllers/users_controller.rb</a></li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/appviewsusersfinishsignuphtmlerb">app/views/users/finish_signup.html.erb</a></li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/appcontrollersapplicationcontrollerrb">app/controllers/application_controller.rb</a></li> </ul> </li> <li><a href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/#/changes">Changes</a></li> </ul> </div> <div class="sidebar-section tags"> <h4>Tags</h4> <ul><li><a href="http://sourcey.com/tags/oauth/">OAuth</a></li><li><a href="http://sourcey.com/tags/programming/">Programming</a></li><li><a href="http://sourcey.com/tags/ruby/">Ruby</a></li><li><a href="http://sourcey.com/tags/rails/">Rails</a></li></ul> </div> </div> </div> <ul class="social-buttons"> <li> <div class="socialite twitter-share socialite-instance socialite-loaded" data-text="Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin" data-url="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-count="vertical" data-default-href="//twitter.com/share" data-socialite="0"><iframe id="twitter-widget-0" scrolling="no" frameborder="0" allowtransparency="true" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/tweet_button.1401325387.html" class="twitter-share-button twitter-tweet-button twitter-share-button twitter-count-vertical" title="Twitter Tweet Button" data-twttr-rendered="true" style="width: 56px; height: 62px;"></iframe></div> </li> <li> <div class="socialite googleplus-one socialite-instance socialite-loaded" data-size="tall" data-href="//sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-default-href="https://plus.google.com/share?url=http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-socialite="1"><div class="g-plusone" data-size="tall" data-href="//sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-default-href="https://plus.google.com/share?url=http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-socialite="1" id="___plusone_0" style="text-indent: 0px; margin: 0px; padding: 0px; background-color: transparent; border-style: none; float: none; line-height: normal; font-size: 1px; vertical-align: baseline; display: inline-block; width: 50px; height: 60px; background-position: initial initial; background-repeat: initial initial;"><iframe frameborder="0" hspace="0" marginheight="0" marginwidth="0" scrolling="no" style="position: static; top: 0px; width: 50px; margin: 0px; border-style: none; left: 0px; visibility: visible; height: 60px;" tabindex="0" vspace="0" width="100%" id="I0_1402177864889" name="I0_1402177864889" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/fastbutton.html" data-gapiattached="true" title="+1"></iframe></div></div> </li> <li> <div class="socialite facebook-like socialite-instance socialite-loaded" data-href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" data-default-href="//www.facebook.com/sharer.php?u=http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/&amp;t=Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin" data-socialite="2"><div class="fb-like fb_iframe_widget" data-href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" data-default-href="//www.facebook.com/sharer.php?u=http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/&amp;t=Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin" data-socialite="2" fb-xfbml-state="rendered" fb-iframe-plugin-query="app_id=&amp;href=http%3A%2F%2Fsourcey.com%2Frails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin%2F&amp;layout=box_count&amp;locale=en_GB&amp;sdk=joey&amp;send=false&amp;show_faces=false&amp;width=60"><span style="vertical-align: bottom; width: 47px; height: 61px;"><iframe name="f4a0321f8" width="60px" height="1000px" frameborder="0" allowtransparency="true" scrolling="no" title="fb:like Facebook Social Plugin" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/like.html" class="" style="border: none; visibility: visible; width: 47px; height: 61px;"></iframe></span></div></div> </li> <li> <div class="socialite linkedin-share socialite-instance socialite-loaded" data-url="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-counter="top" data-default-href="//www.linkedin.com/shareArticle?mini=true&amp;url=http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/&amp;title=Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin" data-socialite="3"><span class="IN-widget" style="line-height: 1; vertical-align: baseline; display: inline-block; text-align: center;"><span style="padding: 0px !important; margin: 0px !important; text-indent: 0px !important; display: inline-block !important; vertical-align: baseline !important; font-size: 1px !important;"><span id="li_ui_li_gen_1402177864926_1-container" class="IN-top"><span id="li_ui_li_gen_1402177864926_1" class="IN-top"><span id="li_ui_li_gen_1402177864926_1-inner" class="IN-top"><span id="li_ui_li_gen_1402177864926_1-content" class="IN-top">1</span></span></span></span></span><br><span style="padding: 0px !important; margin: 0px !important; text-indent: 0px !important; display: inline-block !important; vertical-align: baseline !important; font-size: 1px !important;"><span id="li_ui_li_gen_1402177864917_0"><a id="li_ui_li_gen_1402177864917_0-link" href="javascript:void(0);"><span id="li_ui_li_gen_1402177864917_0-logo">in</span><span id="li_ui_li_gen_1402177864917_0-title"><span id="li_ui_li_gen_1402177864917_0-mark"></span><span id="li_ui_li_gen_1402177864917_0-title-text">Share</span></span></a></span></span></span><script type="IN/Share+init" data-url="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-counter="top" data-default-href="//www.linkedin.com/shareArticle?mini=true&amp;url=http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/&amp;title=Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin" data-socialite="3"></script></div> </li> </ul> <article> <div id="disqus_thread"><iframe id="dsq-2" data-disqus-uid="2" allowtransparency="true" frameborder="0" tabindex="0" title="Disqus" width="100%" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/saved_resource.html" scrolling="no" horizontalscrolling="no" verticalscrolling="no" style="width: 100% !important; border: none !important; overflow: hidden !important; height: 8770px !important;"></iframe><iframe id="dsq-indicator-north" data-disqus-uid="indicator-north" allowtransparency="true" frameborder="0" tabindex="0" title="Disqus" scrolling="no" style="width: 970px !important; border: none !important; overflow: hidden !important; top: 0px !important; min-width: 970px !important; max-width: 970px !important; position: fixed !important; z-index: 2147483646 !important; height: 29px !important; min-height: 29px !important; max-height: 29px !important; display: none !important;"></iframe><iframe id="dsq-indicator-south" data-disqus-uid="indicator-south" allowtransparency="true" frameborder="0" tabindex="0" title="Disqus" scrolling="no" style="width: 970px !important; border: none !important; overflow: hidden !important; bottom: 0px !important; min-width: 970px !important; max-width: 970px !important; position: fixed !important; z-index: 2147483646 !important; height: 29px !important; min-height: 29px !important; max-height: 29px !important; display: none !important;"></iframe></div> <script>
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'sourcey'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script> <noscript>Please enable JavaScript to view the &lt;a href="//disqus.com/?ref_noscript" rel=nofollow&gt;comments powered by Disqus.&lt;/a&gt;</noscript>  </article></div> <footer id="footer"> <p> As with all business minded artists, we have fought the inevitable battle of conformity vs expression, and have emerged victorious with sanity intact to plunder the digiverse in search of new and interesting challenges. For more information, or a quote, drop us an email and tell us what you're working on. </p> <p> ©2014 Sourcey </p><p> </p></footer>   <script src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/all.js"></script></article></div><script src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/widgets.js" id="twitter-wjs" charset="utf-8" async=""></script><script src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/plusone.js" async="" gapi_processed="true"></script><div id="fb-root" class=" fb_reset"><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe name="fb_xdm_frame_http" frameborder="0" allowtransparency="true" scrolling="no" id="fb_xdm_frame_http" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tabindex="-1" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/V80PAcvrynR.html" style="border: none;"></iframe><iframe name="fb_xdm_frame_https" frameborder="0" allowtransparency="true" scrolling="no" id="fb_xdm_frame_https" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tabindex="-1" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/V80PAcvrynR(1).html" style="border: none;"></iframe></div></div><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div></div></div></div><script src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/all(1).js" id="facebook-jssdk" async=""></script><script src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/in.js" async=""></script><script type="text/javascript" src="chrome-extension://bmdblncegkenkacieihfhpjfppoconhi/in-page-script.js"></script><iframe name="oauth2relay273450173" id="oauth2relay273450173" src="./Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin_files/postmessageRelay.html" tabindex="-1" style="width: 1px; height: 1px; position: absolute; top: -100px;"></iframe></body></html>